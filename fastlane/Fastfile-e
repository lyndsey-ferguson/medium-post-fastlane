
fastlane_version '2.54.4'

default_platform :ios

require 'plist'
require 'xcodeproj'

platform :ios do
  before_all do
  end

  desc 'Runs all the tests'
  lane :test do
    scan
  end

  desc 'Sets the Push Entitlement'
  lane :enable_push do
    update_entitlements_file do |plist|
      plist['aps-environment'] = 'development'
    end
    write_push_capability(true)
  end

  desc 'Removes the Push Entitlement'
  lane :disable_push do
    update_entitlements_file do |plist|
      plist.delete('aps-environment')
    end
    write_push_capability(false)
  end

  after_all do |lane|
  end
end

def update_entitlements_file
  entitlements_filepath = File.absolute_path('../notification-examples-ios10/notif10swift/notif10swift/notif10swift.entitlements')

  plist = Plist.parse_xml(entitlements_filepath)
  yield plist
  plist.save_plist(entitlements_filepath)
end

def update_app_capabilities
  project = Xcodeproj::Project.open('../notification-examples-ios10/notif10swift/notif10swift.xcworkspace')
  target = project.native_targets.find { |s| s.name == 'notif10swift' }
  yield(target)
  project.save
end

def write_push_capability(enabled)
  update_app_capabilities do |capabilities|
    capabilities['com.apple.Push']['enabled'] = enabled ? '1' : '0'
  end
end
